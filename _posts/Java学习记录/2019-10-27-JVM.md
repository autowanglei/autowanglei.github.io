# JVM

## Java内存区域

运行时数据区域

- **程序计数器**

  程序计数器是一块较小的内存空间，它可以看作是当前线程所执行的字节码的行号指示器。 

- **虚拟机栈** 

  每个方法在被调用时都会创建一个栈帧，方法从调用到执行完成的过程，就对应着一个栈帧在虚拟机栈中入栈到出栈的过程。

- **本地方法栈** 

  本地方法栈和虚拟机栈所发挥的作用是非常相似的，它们之间的区别不过是虚拟机栈为虚拟机执行Java方法服务，而本地方法栈则为虚拟机使用到的Native方法服务。 

- **Java堆** 

  是Java虚拟机所管理的内存中最大的一块。Java堆是被所有线程共享的一块内存区域，对象实例在这里分配内存。是GC管理的主要区域。

- **方法区**  

  方法区用于存储已被虚拟机加载的类信息、常量、静态变量、即时编译期编译后的代码等数据。  运行时常量池是方法区的一部分 。

## 垃圾回收算法

- 标记-清除算法

  将活跃对象进行标记，将未标记的对象清除。导致会存在很多内存碎片。

- 复制算法

  标记存活对象，将存活对象复制到新的内存空间，清空原来空间。解决了内存碎片问题，缺点：内存浪费，总有一半的内存空间未被利用。

- 标记-整理算法

  移动存活对象，一次性回收需要回收的区域。内存区域快整体移动，影响性能。

- 分代收集

  新生代复制算法,老年代以标记整理算法为主。

## 类加载机制和双亲委派模型

- 类加载过程

  - 加载

    加载指的是将类的class文件读入到内存，并为之创建一个java.lang.Class对象。

  - 连接：把类的二进制数据合并到JRE中 

    1. 验证：检验被加载的类是否符合当前虚拟机的要求，有没有危害虚拟机安全的代码。

       

       四种验证：

       - 文件格式验证：主要验证字节流是否符合Class文件格式规范 。
       - 元数据验证：分析字节码描述的信息，是否符合java的语言语法的规范。
       - 字节码验证： 分析数据流和控制，确定语义是合法的，符合逻辑的。 
       - 符号引用验证 ：保证引用一定会被访问到，不会出现类等无法访问的问题 。

    2. 准备：为类的静态变量分配内存，并设置默认初始值。

    3. 解析：将类的二进制数据中的符号引用替换成直接引用。 

  - 初始化： 初始化是为类的静态变量赋予实际的初始值。

  - 使用 new

  - 卸载 GC

- 类加载器

  - 启动类加载器：加载JAVA_HOME/lib目录下
  - 扩展类加载器。加载JAVA_HOME/lib目录下
  - 应用程序类加载器：加载用户路径上指定的类库

- 双亲委派模型

  如果一个类加载器收到了类加载器的请求，首先加载任务委托给父类加载器，依次递归，直到启动类加载器。如果父类加载器能够完成加载任务，就成功返回；否则，子加载器才会尝试自己去加载。

  双亲委派模型的优点：java类随着它的加载器一起具备了一种带有优先级的层次关系，保证java程序稳定运行。

  

  **虚拟机中决定一个类是否唯一：类本身和加载类的类加载器。**