# 定义

 优化处理 应用程序的**内存使用、空间占用** 

# 作用

 避免因不正确使用内存 & 缺乏管理，从而出现 **内存泄露`（ML）`、内存溢出`（OOM）`、内存空间占用过大** 等问题，最终导致应用程序崩溃（`Crash`） 

# 储备知识：Android 内存管理机制

# 常见的内存问题 & 优化方案

- 常见的内存问题如下
  1. 内存泄露
  2. 内存抖动
  3. 图片`Bitmap`相关
  4. 代码质量 & 数量
  5. 日常不正确使用
- 下面，我将详细分析每项的内存问题 & 给出优化方案

## 内存泄露

### 内存泄漏根本原因：

内存泄漏是指本该回收的对象，因为某些原因不能被回收，从而继续停留在内存中。

根本原因是持有者的什么周期>被引用者的生命周期。

###  常见内存泄露

- 集合
- static关键字修饰的成员变量
- 非静态内部类/匿名类
- 资源对象使用后未关闭

### 优化方案

## 图片资源Bitmap相关

### 优化原因

Android系统给每个应用分配的内存是有限的，而图片资源非常消耗内存（即Bitmap），对Bitmap的使用和内存管理稍有不慎就会引发内存溢出，最终导致OOM。

### 优化方向

- 使用完毕后释放图片资源

  - 优化原因

    使用完毕后若不释放图片资源，容易造成**内存泄露，从而导致内存溢出** 

  -  优化方案 

    a. 在 `Android2.3.3（API 10）`前，调用 `Bitmap.recycle()`方法
    b. 在 `Android2.3.3（API 10）`后，采用软引用`（SoftReference）` 

  -  具体描述
    在 `Android2.3.3（API 10）`前、后，Bitmap对象 & 其像素数据 的存储位置不同，从而导致释放图片资源的方式不同。

- 根据分辨率适配&缩放图片

  - 优化原因

     若 `Bitmap` 与 当前设备的分辨率不匹配，则会拉伸`Bitmap`，而`Bitmap`分辨率增加后，所占用的内存也会相应增加 。

  - 优化方案

    1. 设置多套资源图片（设置支持最大分辨率的一套资源图片），将图片放到不同的资源文件夹中。
    2. BitmapFacyory.decodeResource()，对bitmap根据当前设备分辨率进行缩放适配，在占用最小内存的前提下，达到最佳显示效果。
    3. BitmapFactory.inSampleSize，设置图片缩放比例，避免不必要的大图载入

- 按需选择合适的解码方式

  - 优化原因

    不同的图片解码方式对应的内存占用大小相差很大。

    ![解码方式](https://raw.githubusercontent.com/autowanglei/autowanglei.github.io/master/_posts/android/Android学习记录/bitmap解码方式.jpg)

- 设置图片缓存

### 具体优化方案

# 弱引用软引用

- WeakReference

   WeakReference<T>：弱引用-->随时可能会被垃圾回收器回收，不一定要等到虚拟机内存不足时才强制回收。

  ```
   WeakReference sr = new` `WeakReference(new User());
  ```

  防止内存泄漏，要保证内存被虚拟机回收。

- SoftReference

   SoftReference<T>：软引用-->当虚拟机内存不足时，将会回收它指向的对象。

  ```java
  SoftReference<Drawable> softReference = mImageCache.get(imageUrl);  
  ```

   多用作来实现缓存机制(cache) 。